
# Source: tasks/templates/task-ods-build-go.yaml
apiVersion: tekton.dev/v1beta1
kind: 'Task'
metadata:
  name: 'ods-build-go'
  annotations:
    "helm.sh/resource-policy": keep
spec:
  description: |
    Builds Go (module) applications.

    See https://github.com/opendevstack/ods-pipeline/blob/v0.13.2/docs/tasks/ods-build-go.adoc
  params:
    - name: working-dir
      description: |
        Working directory. The path must be relative to the root of the repository,
        without leading `./` and trailing `/`.
      type: string
      default: "."
    - name: enable-cgo
      description: Whether to enable CGO. When not enabled the build will set `CGO_ENABLED=0`.
      type: string
      default: "false"
    - name: go-os
      description: "`GOOS` variable (the execution operating system such as `linux`, `windows`)."
      type: string
      default: "linux"
    - name: go-arch
      description: "`GOARCH` variable (the execution architecture such as `arm`, `amd64`)."
      type: string
      default: "amd64"
    - name: output-dir
      description: >-
        Path to the directory into which the resulting Go binary should be copied, relative to `working-dir`.
        This directory may then later be used as Docker context for example.
      type: string
      default: docker
    - name: cache-sources
      description: |
        List of build source directories (as colon separated string) which influence the build.
        These directories are relative to the repository root.
        If the contents in these directories change the cache is invalidated so that the build task will rebuild from scratch.
        If left empty no caching is enabled. When sources are only in the working-dir, this value can be the same value.
      type: string
      default: ""
    - name: build-script
      description: >-
        Build script to execute. The
        link:https://github.com/opendevstack/ods-pipeline/blob/master/build/package/scripts/build-go.sh[default script]
        is located in the container image. If you specify a relative path
        instead, it will be resolved from the workspace. See the task definition
        for details how the build script is invoked.
      type: string
      default: "/usr/local/bin/build-go"
    - name: pre-test-script
      description: Script to execute before running tests, relative to the working directory.
      type: string
      default: ""
    - name: sonar-quality-gate
      description: Whether the SonarQube quality gate needs to pass for the task to succeed.
      type: string
      default: "false"
    - name: sonar-skip
      description: Whether to skip SonarQube analysis or not.
      type: string
      default: "false"
  results:
    - description: The cache location that the build task used. If caching is not enabled this will be an empty string.
      name: build-reused-from-location
  steps:
    - name: build-go-binary
      # Image is built from build/package/Dockerfile.go-toolset.
      image: 'ghcr.io/opendevstack/ods-pipeline/ods-go-toolset:0.13.2'
      env:
        - name: HOME
          value: '/tekton/home'
        - name: CI
          value: "true"
        - name: DEBUG
          valueFrom:
            configMapKeyRef:
              key: debug
              name: ods-pipeline
      resources:
        {}
      script: |
        supply-sonar-project-properties-default --working-dir=$(params.working-dir)
        echo -n "" > $(results.build-reused-from-location.path)
        cache_build_key=go-$(params.go-os)-$(params.go-arch)
        if copy-build-if-cached \
          --cache-build-key="$cache_build_key" \
          --cache-sources=$(params.cache-sources) \
          --cached-outputs=$(params.output-dir) \
          --cache-location-used-path=$(results.build-reused-from-location.path) \
          --working-dir=$(params.working-dir) \
          --debug=${DEBUG} ; then
          exit 0
        fi
        # Default build script is build/package/scripts/build-go.sh.
        set +e 
        $(params.build-script) \
          --working-dir=$(params.working-dir) \
          --enable-cgo=$(params.enable-cgo) \
          --go-os=$(params.go-os) \
          --go-arch=$(params.go-arch) \
          --pre-test-script=$(params.pre-test-script) \
          --output-dir=$(params.output-dir) \
          --debug=${DEBUG}
        build_exit=$?
        set -e
        copy-artifacts --debug=${DEBUG}
        if [ $build_exit -ne 0 ]; then
          exit $build_exit
        fi
        cache-build \
          --cache-build-key="$cache_build_key" \
          --cache-sources=$(params.cache-sources) \
          --cached-outputs=$(params.output-dir) \
          --cache-location-used-path=$(results.build-reused-from-location.path) \
          --working-dir=$(params.working-dir) \
          --debug=${DEBUG}
      volumeMounts:
        - mountPath: /etc/ssl/certs/private-cert.pem
          name: private-cert
          readOnly: true
          subPath: tls.crt
      workingDir: $(workspaces.source.path)    
    - name: scan-with-sonar
      # Image is built from build/package/Dockerfile.sonar.
      image: 'ghcr.io/opendevstack/ods-pipeline/ods-sonar:0.13.2'
      env:
        - name: HOME
          value: '/tekton/home'
        - name: SONAR_URL
          valueFrom:
            configMapKeyRef:
              key: url
              name: ods-sonar
        - name: SONAR_EDITION
          valueFrom:
            configMapKeyRef:
              key: edition
              name: ods-sonar
        - name: SONAR_AUTH_TOKEN
          valueFrom:
            secretKeyRef:
              key: password
              name: ods-sonar-auth
        - name: DEBUG
          valueFrom:
            configMapKeyRef:
              key: debug
              name: ods-pipeline
      resources: {}
      script: |
        if [ "$(params.sonar-skip)" = "true" ]; then
          echo "Skipping SonarQube analysis"
        else
          mkdir -p .ods/artifacts/sonarqube-analysis
    
          truststore="${JAVA_HOME}/lib/security/cacerts"
          if [ -f /etc/ssl/certs/private-cert.pem ]; then
            truststore="$(pwd)/.ods-cache/truststore/cacerts"
            configure-truststore --dest-store "${truststore}"
          fi
          # sonar is built from cmd/sonar/main.go.
          sonar \
            -working-dir=$(params.working-dir) \
            -quality-gate=$(params.sonar-quality-gate) \
            -truststore "${truststore}"
        fi
      volumeMounts:
        - mountPath: /etc/ssl/certs/private-cert.pem
          name: private-cert
          readOnly: true
          subPath: tls.crt
      workingDir: $(workspaces.source.path)
  volumes:
    - name: private-cert
      secret:
        secretName: ods-private-cert
        optional: true
  workspaces:
    - name: source
